<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>منصّة عقارك - الصفحة الرئيسية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- خط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS (نسخة RTL) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- أيقونات Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    :root {
      --font-family: 'Cairo', sans-serif;
      --primary-color: #2B2D42;
      --secondary-color: #F8F9FA;
      --accent-color: #EF233C;
      --header-gradient: linear-gradient(135deg, #2B2D42, #3C4059);
      --header-text-color: #fff;
      --radius: 10px;
      --featured-color: #ff9900;
      --exclusive-color: #9c27b0;
      --new-color: #4CAF50;
      --for-sale-color: #2196F3;
      --for-rent-color: #673AB7;
    }
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: var(--font-family);
      background-color: var(--secondary-color);
      margin: 0;
      padding-top: 100px;
      color: var(--primary-color);
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--header-gradient);
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      z-index: 1100;
      color: var(--header-text-color);
    }
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-container h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }
    .login-btn {
      background-color: transparent;
      border: 1px solid var(--header-text-color);
      color: var(--header-text-color);
      border-radius: 5px;
      padding: 5px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .login-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    #visitorCount {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-right: auto;
      margin-left: 15px;
    }
    #loginPanel {
      display: none;
      position: fixed;
      top: 100px;
      right: 20px;
      width: 300px;
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 2000;
      border-radius: var(--radius);
    }
    #loginPanel h5 {
      color: var(--accent-color);
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
    }
    #adminPanel {
      display: none;
      background: #fff;
      padding: 20px;
      border: 2px solid var(--accent-color);
      border-radius: var(--radius);
      max-width: 1200px;
      margin: 80px auto 40px;
    }
    #adminPanel h3 {
      color: var(--accent-color);
      font-weight: 700;
      margin-bottom: 20px;
    }
    .action-badge {
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 5px;
      margin: 2px;
    }
    .action-badge.edit {
      background-color: #0d6efd;
      color: #fff;
    }
    .action-badge.delete {
      background-color: #dc3545;
      color: #fff;
    }
    .hero-section {
      background: url("https://source.unsplash.com/1200x500/?house") center center/cover no-repeat;
      position: relative;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      margin-top: 60px;
    }
    .hero-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1;
    }
    .hero-content {
      position: relative;
      z-index: 2;
      max-width: 600px;
      padding: 20px;
    }
    .hero-content h2 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    .hero-content p {
      font-size: 1.2rem;
      margin-bottom: 20px;
    }
    .btn-hero {
      background-color: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 50px;
      padding: 10px 30px;
      font-size: 1.1rem;
      transition: 0.3s;
    }
    .btn-hero:hover {
      background-color: #fff;
      color: var(--accent-color);
    }
    .category-title {
      color: var(--accent-color);
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }
    .category-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: center;
    }
    .category-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .category-icon {
      font-size: 1.8rem;
      color: var(--accent-color);
      margin-bottom: 5px;
    }
    .category-text {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }
    .property-list-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent-color);
      margin-bottom: 20px;
      text-align: center;
    }
    #loadingProperties {
      text-align: center;
      margin: 20px 0;
      font-size: 1.2rem;
      color: var(--primary-color);
    }
    .property-card {
      border: none;
      border-radius: var(--radius);
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .property-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .property-card img {
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      height: 300px;
      object-fit: cover;
      width: 100%;
    }
    .badge-category {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--accent-color);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      z-index: 2;
    }
    .property-card .card-body {
      padding: 15px;
      flex-grow: 1;
    }
    .property-card h5 {
      font-weight: 700;
      font-size: 1.2rem;
    }
    .property-card p {
      font-weight: 700;
      font-size: 1rem;
    }
    #propertyDetailPage {
      display: none;
      padding: 20px;
    }
    .carousel-item img {
      border-radius: var(--radius);
      height: 400px;
      object-fit: cover;
      width: 100%;
    }
    .description-text {
      white-space: pre-line;
      font-size: 1.1rem;
      font-weight: bold;
      line-height: 1.6;
      color: #333;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: var(--radius);
      border-left: 3px solid var(--accent-color);
      margin: 15px 0;
    }
    .btn-whatsapp {
      font-size: 1.5rem;
      padding: 15px 30px;
      border-radius: 5px;
      animation: pulse 2s infinite;
    }
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1300;
    }
    .spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
      }
    }
    #additionalImagesPreview img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-right: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .featured-tag {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--featured-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: bold;
      z-index: 3;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .exclusive-tag {
      position: absolute;
      top: 45px;
      right: 10px;
      background: var(--exclusive-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: bold;
      z-index: 3;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .new-tag {
      position: absolute;
      top: 80px;
      right: 10px;
      background: var(--new-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: bold;
      z-index: 3;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .featured-property {
      border: 3px solid var(--featured-color);
      animation: featuredPulse 2s infinite;
    }
    .exclusive-property {
      border: 3px solid var(--exclusive-color);
      box-shadow: 0 0 15px rgba(156, 39, 176, 0.4);
    }
    @keyframes featuredPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 153, 0, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(255, 153, 0, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 153, 0, 0);
      }
    }
    .feature-control {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: var(--radius);
    }
    .feature-control label {
      margin-right: 10px;
      margin-bottom: 0;
      font-weight: 600;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider.featured {
      background-color: var(--featured-color);
    }
    input:checked + .slider.exclusive {
      background-color: var(--exclusive-color);
    }
    input:checked + .slider.new {
      background-color: var(--new-color);
    }
    .filter-section {
      background-color: #fff;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .filter-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    .filter-title i {
      margin-left: 10px;
      color: var(--accent-color);
    }
    .range-value {
      font-weight: bold;
      color: var(--accent-color);
    }
    .advanced-filters {
      display: none;
    }
    .customer-ad-card {
      border: 1px solid #eee;
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    .customer-ad-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .customer-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .customer-name {
      font-weight: 700;
      color: var(--primary-color);
    }
    .ad-status {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .ad-status.pending {
      background-color: #FFC107;
      color: #333;
    }
    .ad-status.approved {
      background-color: #28A745;
      color: white;
    }
    .ad-status.rejected {
      background-color: #DC3545;
      color: white;
    }
    .add-property-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background-color: var(--accent-color);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s;
    }
    .add-property-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    #customerPropertyForm {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 3000;
      overflow-y: auto;
    }
    .customer-form-container {
      background-color: white;
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      position: relative;
    }
    .close-form {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      transition: color 0.2s;
    }
    .close-form:hover {
      color: var(--accent-color);
    }
    .form-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .form-section-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    .projects-section {
      padding: 40px 0;
      background-color: #f8f9fa;
    }
    .project-card {
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      background-color: white;
      transition: transform 0.3s;
    }
    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .project-card img {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }
    .project-details {
      padding: 15px;
    }
    .project-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    .project-description {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 15px;
    }
    .project-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #777;
    }
    .nav-tabs .nav-link {
      font-weight: 600;
      color: var(--primary-color);
      padding: 10px 20px;
      border: none;
      border-radius: 0;
      transition: all 0.3s;
    }
    .nav-tabs .nav-link.active {
      color: var(--accent-color);
      background-color: transparent;
      border-bottom: 3px solid var(--accent-color);
    }
    .tab-pane {
      padding: 20px 0;
    }
    @media (max-width: 768px) {
      body { padding-top: 110px; }
      .property-card img { height: 300px; }
      .customer-form-container { margin: 20px; }
      .project-card img { height: 200px; }
    }
  </style>
  
  <!-- Firebase SDKs (استخدام النسخ compat لتسهيل التكامل مع الكود الحالي) -->
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script>
    // إعدادات Firebase (تأكد من مطابقتها لبيانات مشروعك)
    const firebaseConfig = {
      apiKey: "AIzaSyDoSbh_hpAW_wmbQ6UBnfd75wLn5ArA5Cs",
      authDomain: "aqarati-d0de2.firebaseapp.com",
      databaseURL: "https://aqarati-d0de2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "aqarati-d0de2",
      storageBucket: "aqarati-d0de2.appspot.com",
      messagingSenderId: "325937679598",
      appId: "1:325937679598:web:b5da3e5f0563e87024b7ff",
      measurementId: "G-J5QRQ1WM7V"
    };

    // تهيئة Firebase واستخدام بيانات محلية في حال فشل الاتصال
    let propertiesRef, nextIdRef, customerAdsRef, projectsRef;
    
    try {
      firebase.initializeApp(firebaseConfig);
      
      if (typeof firebase.analytics === 'function') {
        firebase.analytics();
      }
      
      propertiesRef = firebase.database().ref("properties");
      nextIdRef = firebase.database().ref("nextId");
      customerAdsRef = firebase.database().ref("customerAds");
      projectsRef = firebase.database().ref("projects");
      
      console.log("تم تهيئة Firebase بنجاح");
    } catch (error) {
      console.error("خطأ في تهيئة Firebase:", error);
      
      // إنشاء refs وهمية في حالة فشل الاتصال
      const dummyRef = {
        once: () => Promise.resolve({ val: () => null }),
        transaction: (fn) => Promise.resolve({ committed: true, snapshot: { val: () => 1 } }),
        child: () => dummyRef,
        set: () => Promise.resolve(),
        remove: () => Promise.resolve(),
        update: () => Promise.resolve()
      };
      
      propertiesRef = dummyRef;
      nextIdRef = dummyRef;
      customerAdsRef = dummyRef;
      projectsRef = dummyRef;
    }
    
    // بيانات محلية للعقارات (تستخدم في حال فشل الاتصال)
    const localProperties = [
      {
        id: 1,
        title: "فيلا فاخرة في حي الفيصلية",
        location: "الطائف - حي الفيصلية",
        district: "الفيصلية",
        price: 2500000,
        category: "فلل",
        purpose: "للبيع",
        description: "فيلا فاخرة مكونة من دورين و6 غرف وصالة كبيرة ومسبح.",
        mainImage: "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800&auto=format",
        images: [],
        isFeatured: true,
        isExclusive: false,
        isNew: true,
        viewCount: 150,
        updatedAt: Date.now(),
        createdAt: Date.now() - 86400000
      },
      {
        id: 2,
        title: "شقة واسعة للإيجار",
        location: "الطائف - حي النزهة",
        district: "النزهة",
        price: 25000,
        category: "شقق",
        purpose: "للإيجار",
        description: "شقة واسعة مكونة من 3 غرف وصالة ومطبخ. قريبة من الخدمات.",
        mainImage: "https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800&auto=format",
        images: [],
        isFeatured: false,
        isExclusive: true,
        isNew: false,
        viewCount: 75,
        updatedAt: Date.now(),
        createdAt: Date.now() - 172800000
      },
      {
        id: 3,
        title: "أرض سكنية في حي الربوة",
        location: "الطائف - حي الربوة",
        district: "الربوة",
        price: 850000,
        category: "أراضي",
        purpose: "للبيع",
        description: "أرض سكنية مساحة 750 متر مربع. مناسبة للفلل.",
        mainImage: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&auto=format",
        images: [],
        isFeatured: false,
        isExclusive: false,
        isNew: true,
        viewCount: 45,
        updatedAt: Date.now(),
        createdAt: Date.now() - 259200000
      }
    ];
  </script>
</head>
<body>
  <!-- الهيدر -->
  <header class="header">
    <div class="header-container">
      <h1>منصّة عقارك</h1>
      <div id="visitorCount">عدد الزائرين: 0</div>
      <button class="login-btn" id="loginLogoutBtn" onclick="toggleLoginPanel()">دخول الإدارة</button>
    </div>
  </header>
  
  <!-- نموذج تسجيل الدخول -->
  <div id="loginPanel">
    <h5>تسجيل الدخول</h5>
    <label for="usernameInput" class="form-label">اسم المستخدم</label>
    <input type="text" id="usernameInput" class="form-control" placeholder="اكتب اسم المستخدم">
    <label for="passwordInput" class="form-label mt-2">كلمة المرور</label>
    <input type="password" id="passwordInput" class="form-control" placeholder="اكتب كلمة المرور">
    <button class="btn btn-primary mt-3 w-100" onclick="performLogin()">دخول</button>
  </div>
  
  <!-- لوحة الإدارة -->
  <div id="adminPanel">
    <h3 class="mb-3">لوحة التحكم - إدارة العقارات</h3>
    
    <!-- تبويبات الإدارة -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties-tab-pane" type="button" role="tab" aria-controls="properties-tab-pane" aria-selected="true">العقارات</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="customer-ads-tab" data-bs-toggle="tab" data-bs-target="#customer-ads-tab-pane" type="button" role="tab" aria-controls="customer-ads-tab-pane" aria-selected="false">إعلانات العملاء</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects-tab-pane" type="button" role="tab" aria-controls="projects-tab-pane" aria-selected="false">المشاريع العقارية</button>
      </li>
    </ul>
    
    <div class="tab-content" id="adminTabsContent">
      <!-- تبويب العقارات -->
      <div class="tab-pane fade show active" id="properties-tab-pane" role="tabpanel" aria-labelledby="properties-tab" tabindex="0">
        <form id="propertyForm" class="mb-4">
          <input type="hidden" id="propertyId">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="title" class="form-label">العنوان</label>
              <input type="text" id="title" class="form-control" placeholder="مثلاً: عقار 1 - عمارة سكنية" required>
            </div>
            <div class="col-md-6">
              <label for="location" class="form-label">الموقع</label>
              <input type="text" id="location" class="form-control" placeholder="مثلاً: الطايف - حي ..." required>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="district" class="form-label">الحي</label>
              <select id="district" class="form-select" required>
                <option value="">اختر الحي</option>
                <option value="الفيصلية">الفيصلية</option>
                <option value="المثناة">المثناة</option>
                <option value="الشهداء">الشهداء</option>
                <option value="النسيم">النسيم</option>
                <option value="الروضة">الروضة</option>
                <option value="الربوة">الربوة</option>
                <option value="شبرا">شبرا</option>
                <option value="الوشحاء">الوشحاء</option>
                <option value="السلامة">السلامة</option>
                <option value="النزهة">النزهة</option>
                <option value="أخرى">أخرى</option>
              </select>
            </div>
            <div class="col-md-6">
              <div id="otherDistrictContainer" style="display: none;">
                <label for="otherDistrict" class="form-label">اسم الحي (أخرى)</label>
                <input type="text" id="otherDistrict" class="form-control" placeholder="اكتب اسم الحي">
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="price" class="form-label">السعر (مثال: 1500000)</label>
              <input type="text" id="price" class="form-control" placeholder="اكتب السعر بالأرقام" required>
            </div>
            <div class="col-md-4">
              <label for="category" class="form-label">التصنيف</label>
              <select id="category" class="form-select" required>
                <option value="">اختر التصنيف</option>
                <option value="عمائر">عمائر</option>
                <option value="فلل">فلل</option>
                <option value="شقق">شقق</option>
                <option value="استراحات">استراحات</option>
                <option value="أدوار مستقلة">أدوار مستقلة</option>
                <option value="أراضي">أراضي</option>
                <option value="مشاريع عقارية">مشاريع عقارية</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="purpose" class="form-label">الغرض</label>
              <select id="purpose" class="form-select" required>
                <option value="">اختر الغرض</option>
                <option value="للبيع">للبيع</option>
                <option value="للإيجار">للإيجار</option>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="feature-control">
                <label for="isFeatured">عقار مميز</label>
                <label class="toggle-switch ms-2">
                  <input type="checkbox" id="isFeatured">
                  <span class="slider featured"></span>
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="feature-control">
                <label for="isExclusive">عرض حصري</label>
                <label class="toggle-switch ms-2">
                  <input type="checkbox" id="isExclusive">
                  <span class="slider exclusive"></span>
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="feature-control">
                <label for="isNew">جديد</label>
                <label class="toggle-switch ms-2">
                  <input type="checkbox" id="isNew">
                  <span class="slider new"></span>
                </label>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="mainImageFile" class="form-label">الصورة الرئيسية</label>
              <input type="file" id="mainImageFile" class="form-control" accept="image/*">
            </div>
            <div class="col-md-6">
              <label for="additionalImages" class="form-label">الصور الإضافية (يمكن اختيار أكثر من ملف)</label>
              <input type="file" id="additionalImages" class="form-control" accept="image/*" multiple>
            </div>
          </div>
          <div class="mb-3">
            <div id="additionalImagesPreview" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">
              الوصف <i class="bi bi-whatsapp text-success"></i>
            </label>
            <textarea id="description" class="form-control" rows="3" placeholder="تفاصيل العقار"></textarea>
          </div>
          <div class="d-flex align-items-center flex-wrap gap-2">
            <button type="submit" class="btn btn-success" id="saveBtn">حفظ التعديلات</button>
            <button type="reset" class="btn btn-secondary" id="resetForm">إعادة تعيين</button>
            <button type="button" class="btn btn-info" id="newPropertyBtn">إضافة عقار جديد</button>
            <span id="autoSaveStatus" class="text-success" style="display:none;">تم الحفظ</span>
          </div>
        </form>
        
        <h4>العقارات المُضافة</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle" id="propertiesTable">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>العنوان</th>
                <th>الموقع</th>
                <th>السعر (أرقام)</th>
                <th>التصنيف</th>
                <th>الغرض</th>
                <th>المميزات</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="adminTableBody">
              <!-- سيتم تعبئة الجدول هنا -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- تبويب إعلانات العملاء -->
      <div class="tab-pane fade" id="customer-ads-tab-pane" role="tabpanel" aria-labelledby="customer-ads-tab" tabindex="0">
        <h4 class="mb-3">إعلانات العملاء</h4>
        <div class="mb-3">
          <select id="adStatusFilter" class="form-select w-auto">
            <option value="all">جميع الإعلانات</option>
            <option value="pending">بانتظار الموافقة</option>
            <option value="approved">تمت الموافقة</option>
            <option value="rejected">مرفوضة</option>
          </select>
        </div>
        <div id="customerAdsContainer">
          <!-- سيتم تعبئة إعلانات العملاء هنا -->
          <div class="alert alert-info">جاري تحميل إعلانات العملاء...</div>
        </div>
      </div>
      
      <!-- تبويب المشاريع العقارية -->
      <div class="tab-pane fade" id="projects-tab-pane" role="tabpanel" aria-labelledby="projects-tab" tabindex="0">
        <h4 class="mb-3">المشاريع العقارية</h4>
        <form id="projectForm" class="mb-4">
          <input type="hidden" id="projectId">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="projectTitle" class="form-label">عنوان المشروع</label>
              <input type="text" id="projectTitle" class="form-control" placeholder="مثلاً: مشروع الواحة السكني" required>
            </div>
            <div class="col-md-6">
              <label for="projectLocation" class="form-label">موقع المشروع</label>
              <input type="text" id="projectLocation" class="form-control" placeholder="مثلاً: شمال الطائف" required>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="projectDescription" class="form-label">وصف المشروع</label>
              <textarea id="projectDescription" class="form-control" rows="3" placeholder="وصف تفصيلي للمشروع العقاري" required></textarea>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="projectImageFile" class="form-label">صورة المشروع</label>
              <input type="file" id="projectImageFile" class="form-control" accept="image/*" required>
            </div>
            <div class="col-md-6">
              <label for="projectCompletionDate" class="form-label">تاريخ الانتهاء المتوقع</label>
              <input type="date" id="projectCompletionDate" class="form-control">
            </div>
          </div>
          <div class="mb-3" id="projectImagePreview"></div>
          <div class="d-flex align-items-center flex-wrap gap-2">
            <button type="submit" class="btn btn-success" id="saveProjectBtn">حفظ المشروع</button>
            <button type="reset" class="btn btn-secondary">إعادة تعيين</button>
            <button type="button" class="btn btn-info" id="newProjectBtn">إضافة مشروع جديد</button>
          </div>
        </form>
        
        <h4>المشاريع المضافة</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle" id="projectsTable">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>عنوان المشروع</th>
                <th>الموقع</th>
                <th>تاريخ الانتهاء</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="projectsTableBody">
              <!-- سيتم تعبئة الجدول هنا -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <button class="btn btn-danger mt-3" onclick="performLogout()">تسجيل خروج</button>
  </div>
  
  <!-- قسم Hero -->
  <section class="hero-section">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h2>أهلاً بك في منصّة عقارك</h2>
      <p>ابحث عن أفضل العقارات في مدينة الطائف المناسبة لاحتياجاتك بسهولة ويسر</p>
      <button class="btn-hero" onclick="scrollToProperties()">استعراض العقارات</button>
    </div>
  </section>
  
  <!-- فلتر البحث المتقدم -->
  <section class="container my-5">
    <div class="filter-section">
      <h4 class="filter-title"><i class="bi bi-funnel-fill"></i> فلتر البحث المتقدم</h4>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="filterDistrict" class="form-label">الحي</label>
          <select id="filterDistrict" class="form-select">
            <option value="">جميع الأحياء</option>
            <option value="الفيصلية">الفيصلية</option>
            <option value="المثناة">المثناة</option>
            <option value="الشهداء">الشهداء</option>
            <option value="النسيم">النسيم</option>
            <option value="الروضة">الروضة</option>
            <option value="الربوة">الربوة</option>
            <option value="شبرا">شبرا</option>
            <option value="الوشحاء">الوشحاء</option>
            <option value="السلامة">السلامة</option>
            <option value="النزهة">النزهة</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filterCategory" class="form-label">نوع العقار</label>
          <select id="filterCategory" class="form-select">
            <option value="">جميع الأنواع</option>
            <option value="عمائر">عمائر</option>
            <option value="فلل">فلل</option>
            <option value="شقق">شقق</option>
            <option value="استراحات">استراحات</option>
            <option value="أدوار مستقلة">أدوار مستقلة</option>
            <option value="أراضي">أراضي</option>
            <option value="مشاريع عقارية">مشاريع عقارية</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filterPurpose" class="form-label">الغرض</label>
          <select id="filterPurpose" class="form-select">
            <option value="">جميع الأغراض</option>
            <option value="للبيع">للبيع</option>
            <option value="للإيجار">للإيجار</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="priceRange" class="form-label">السعر: <span id="priceRangeValue" class="range-value">0 - 10,000,000</span> ريال</label>
          <input type="range" class="form-range" id="priceRange" min="0" max="10000000" step="100000" value="10000000">
        </div>
        <div class="col-md-6 mt-4">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="filterFeatured">
            <label class="form-check-label" for="filterFeatured">عقارات مميزة</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="filterExclusive">
            <label class="form-check-label" for="filterExclusive">عروض حصرية</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="filterNew">
            <label class="form-check-label" for="filterNew">عقارات جديدة</label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <button class="btn btn-primary" id="applyFilters">تطبيق الفلتر</button>
          <button class="btn btn-outline-secondary ms-2" id="resetFilters">إعادة تعيين</button>
          <button class="btn btn-link" id="toggleAdvancedFilters">خيارات متقدمة <i class="bi bi-chevron-down"></i></button>
        </div>
      </div>
      <div class="advanced-filters mt-3">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-3">
              <label for="filterRooms" class="form-label">عدد الغرف</label>
              <select id="filterRooms" class="form-select">
                <option value="">الكل</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5+">5+</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label for="filterBathrooms" class="form-label">عدد الحمامات</label>
              <select id="filterBathrooms" class="form-select">
                <option value="">الكل</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4+">4+</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label for="filterArea" class="form-label">المساحة (متر مربع)</label>
              <select id="filterArea" class="form-select">
                <option value="">الكل</option>
                <option value="0-100">أقل من 100</option>
                <option value="100-200">100 - 200</option>
                <option value="200-500">200 - 500</option>
                <option value="500+">أكثر من 500</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label for="sortProperties" class="form-label">الترتيب حسب</label>
              <select id="sortProperties" class="form-select">
                <option value="newest">الأحدث</option>
                <option value="priceAsc">السعر (الأقل للأعلى)</option>
                <option value="priceDesc">السعر (الأعلى للأقل)</option>
                <option value="viewsDesc">الأكثر مشاهدة</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- أقسام العقارات مع خانة بحث -->
  <section class="container my-5">
    <h2 class="category-title">الأقسام العقارية</h2>
    <div class="mb-4">
      <input type="text" id="searchInput" class="form-control" placeholder="ابحث عن عقار (عنوان، موقع، سعر، وصف أو تصنيف)...">
    </div>
    <div class="row row-cols-2 row-cols-md-4 g-3 justify-content-center">
      <div class="col">
        <div class="category-card" onclick="filterProperties('all')">
          <i class="bi bi-card-list category-icon"></i>
          <span class="category-text">عرض الكل</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('عمائر')">
          <i class="bi bi-building category-icon"></i>
          <span class="category-text">عمائر</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('فلل')">
          <i class="bi bi-house category-icon"></i>
          <span class="category-text">فلل</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('شقق')">
          <i class="bi bi-houses category-icon"></i>
          <span class="category-text">شقق</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('استراحات')">
          <i class="bi bi-tree category-icon"></i>
          <span class="category-text">استراحات</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('أدوار مستقلة')">
          <i class="bi bi-layers category-icon"></i>
          <span class="category-text">أدوار مستقلة</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('أراضي')">
          <i class="bi bi-geo-alt category-icon"></i>
          <span class="category-text">أراضي</span>
        </div>
      </div>
      <div class="col">
        <div class="category-card" onclick="filterProperties('مشاريع عقارية')">
          <i class="bi bi-buildings category-icon"></i>
          <span class="category-text">مشاريع عقارية</span>
        </div>
      </div>
    </div>
  </section>
  
  <!-- قائمة العقارات العامة -->
  <section class="container" id="publicContent">
    <h2 class="property-list-title">العقارات المتاحة</h2>
    <div id="loadingProperties">جارٍ تحميل العقارات...</div>
    <div id="propertiesContainer" class="row">
      <!-- بطاقات العقارات ستظهر هنا -->
    </div>
  </section>
  
  <!-- قسم المشاريع العقارية -->
  <section class="projects-section" id="projectsSection">
    <div class="container">
      <h2 class="text-center mb-4">المشاريع العقارية في الطائف</h2>
      <p class="text-center mb-5">تعرف على أحدث المشاريع العقارية المميزة في مدينة الطائف</p>
      <div class="row" id="projectsContainer">
        <!-- سيتم تعبئة المشاريع هنا -->
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- صفحة تفاصيل العقار -->
  <div id="propertyDetailPage">
    <div class="container mt-4">
      <button class="btn btn-secondary mb-3" onclick="backToListing()">عودة للقائمة</button>
      <div id="detailContent">
        <!-- تفاصيل العقار ستظهر هنا -->
      </div>
    </div>
  </div>
  
  <!-- زر إضافة عقار للعميل -->
  <div class="add-property-btn" id="addPropertyBtn">
    <i class="bi bi-plus-lg"></i>
  </div>
  
  <!-- نموذج إضافة عقار من قبل العميل -->
  <div id="customerPropertyForm">
    <div class="customer-form-container">
      <span class="close-form" id="closeForm">&times;</span>
      <h3 class="mb-4 text-center">إضافة عقار جديد</h3>
      
      <form id="newCustomerPropertyForm">
        <div class="form-section">
          <h5 class="form-section-title">معلومات المالك</h5>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="customerName" class="form-label">الاسم الكامل</label>
              <input type="text" id="customerName" class="form-control" placeholder="اكتب اسمك الكامل" required>
            </div>
            <div class="col-md-6">
              <label for="customerPhone" class="form-label">رقم الواتساب</label>
              <input type="tel" id="customerPhone" class="form-control" placeholder="05xxxxxxxx" required>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h5 class="form-section-title">معلومات العقار</h5>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="customerPropertyTitle" class="form-label">عنوان العرض</label>
              <input type="text" id="customerPropertyTitle" class="form-control" placeholder="مثلاً: عمارة سكنية - دور كامل" required>
            </div>
            <div class="col-md-6">
              <label for="customerPropertyDistrict" class="form-label">الحي</label>
              <select id="customerPropertyDistrict" class="form-select" required>
                <option value="">اختر الحي</option>
                <option value="الفيصلية">الفيصلية</option>
                <option value="المثناة">المثناة</option>
                <option value="الشهداء">الشهداء</option>
                <option value="النسيم">النسيم</option>
                <option value="الروضة">الروضة</option>
                <option value="الربوة">الربوة</option>
                <option value="شبرا">شبرا</option>
                <option value="الوشحاء">الوشحاء</option>
                <option value="السلامة">السلامة</option>
                <option value="النزهة">النزهة</option>
                <option value="أخرى">أخرى</option>
              </select>
            </div>
          </div>
          <div class="mb-3" id="customerOtherDistrictContainer" style="display: none;">
            <label for="customerOtherDistrict" class="form-label">اسم الحي (أخرى)</label>
            <input type="text" id="customerOtherDistrict" class="form-control" placeholder="اكتب اسم الحي">
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="customerPropertyPrice" class="form-label">السعر</label>
              <input type="text" id="customerPropertyPrice" class="form-control" placeholder="اكتب السعر بالأرقام" required>
            </div>
            <div class="col-md-4">
              <label for="customerPropertyCategory" class="form-label">التصنيف</label>
              <select id="customerPropertyCategory" class="form-select" required>
                <option value="">اختر التصنيف</option>
                <option value="عمائر">عمائر</option>
                <option value="فلل">فلل</option>
                <option value="شقق">شقق</option>
                <option value="استراحات">استراحات</option>
                <option value="أدوار مستقلة">أدوار مستقلة</option>
                <option value="أراضي">أراضي</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="customerPropertyPurpose" class="form-label">الغرض</label>
              <select id="customerPropertyPurpose" class="form-select" required>
                <option value="">اختر الغرض</option>
                <option value="للبيع">للبيع</option>
                <option value="للإيجار">للإيجار</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="customerPropertyMainImage" class="form-label">الصورة الرئيسية</label>
            <input type="file" id="customerPropertyMainImage" class="form-control" accept="image/*" required>
          </div>
          <div class="mb-3">
            <label for="customerPropertyAdditionalImages" class="form-label">صور إضافية (اختياري)</label>
            <input type="file" id="customerPropertyAdditionalImages" class="form-control" accept="image/*" multiple>
          </div>
          <div class="mb-3">
            <label for="customerPropertyDescription" class="form-label">وصف كامل للعقار</label>
            <textarea id="customerPropertyDescription" class="form-control" rows="5" placeholder="اكتب وصفًا تفصيليًا للعقار يشمل جميع المواصفات المهمة..." required></textarea>
            <small class="text-danger">* يجب كتابة جميع التفاصيل وإلا لن يتم قبول الطلب</small>
          </div>
        </div>
        
        <div class="form-section">
          <h5 class="form-section-title">معلومات إضافية</h5>
          <div class="mb-3">
            <label class="form-label">هل يوجد متعثرات على البيع؟</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="hasIssues" id="hasIssuesNo" value="لا" checked>
              <label class="form-check-label" for="hasIssuesNo">لا يوجد متعثرات</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="hasIssues" id="hasIssuesYesLien" value="يوجد رهن">
              <label class="form-check-label" for="hasIssuesYesLien">يوجد رهن</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="hasIssues" id="hasIssuesYesNoTitle" value="بدون صك">
              <label class="form-check-label" for="hasIssuesYesNoTitle">بدون صك</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="hasIssues" id="hasIssuesYesOther" value="أخرى">
              <label class="form-check-label" for="hasIssuesYesOther">أخرى</label>
            </div>
          </div>
          <div class="mb-3" id="otherIssuesContainer" style="display: none;">
            <label for="otherIssues" class="form-label">يرجى التوضيح</label>
            <input type="text" id="otherIssues" class="form-control" placeholder="اكتب تفاصيل المتعثرات">
          </div>
        </div>
        
        <div class="alert alert-info">
          <h6><i class="bi bi-info-circle"></i> ملاحظات هامة:</h6>
          <ul>
            <li>الإعلان لن يظهر مباشرةً، بل سيتم مراجعته من قبل الإدارة أولاً.</li>
            <li>سيظهر العقار برقم التواصل الخاص بالمنصة (0535342404).</li>
            <li>سيتم التواصل معكم في حال وجود أي استفسارات إضافية.</li>
          </ul>
        </div>
        
        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary" id="submitCustomerProperty">إرسال الطلب</button>
          <button type="button" class="btn btn-outline-secondary" id="cancelCustomerProperty">إلغاء</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Toast Notification Container -->
  <div id="toastContainer"></div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ADMIN_USERNAME = "admin";
    const ADMIN_PASSWORD = "12345";
    const PHONE_NUMBER = "0535342404";

    function showToast(message, type = "success") {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = `alert alert-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }

    function toggleLoginPanel() {
      if(localStorage.getItem("adminLoggedIn") === "true"){
        performLogout();
      } else {
        document.getElementById("loginPanel").style.display = "block";
        window.scrollTo(0,0);
      }
    }

    function performLogin() {
      const user = document.getElementById("usernameInput").value.trim();
      const pass = document.getElementById("passwordInput").value.trim();
      if(user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
        localStorage.setItem("adminLoggedIn", "true");
        document.getElementById("loginPanel").style.display = "none";
        showAdminPanel();
      } else {
        alert("بيانات الدخول غير صحيحة!");
      }
    }
    function performLogout() {
      localStorage.removeItem("adminLoggedIn");
      location.reload();
    }
    function showAdminPanel() {
      document.getElementById("adminPanel").style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // التعامل مع خيار "أخرى" للأحياء
    document.getElementById("district").addEventListener("change", function() {
      const otherDistrictContainer = document.getElementById("otherDistrictContainer");
      if (this.value === "أخرى") {
        otherDistrictContainer.style.display = "block";
      } else {
        otherDistrictContainer.style.display = "none";
      }
    });

    document.getElementById("customerPropertyDistrict").addEventListener("change", function() {
      const otherDistrictContainer = document.getElementById("customerOtherDistrictContainer");
      if (this.value === "أخرى") {
        otherDistrictContainer.style.display = "block";
      } else {
        otherDistrictContainer.style.display = "none";
      }
    });

    // التعامل مع خيار "أخرى" للمتعثرات
    document.querySelectorAll('input[name="hasIssues"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const otherIssuesContainer = document.getElementById("otherIssuesContainer");
        if (this.value === "أخرى") {
          otherIssuesContainer.style.display = "block";
        } else {
          otherIssuesContainer.style.display = "none";
        }
      });
    });

    // فتح وإغلاق نموذج إضافة العقار للعميل
    document.getElementById("addPropertyBtn").addEventListener("click", function() {
      document.getElementById("customerPropertyForm").style.display = "block";
      document.body.style.overflow = "hidden";
    });

    document.getElementById("closeForm").addEventListener("click", function() {
      document.getElementById("customerPropertyForm").style.display = "none";
      document.body.style.overflow = "auto";
    });

    document.getElementById("cancelCustomerProperty").addEventListener("click", function() {
      document.getElementById("customerPropertyForm").style.display = "none";
      document.body.style.overflow = "auto";
    });

    // عرض وإخفاء الفلتر المتقدم
    document.getElementById("toggleAdvancedFilters").addEventListener("click", function() {
      const advancedFilters = document.querySelector(".advanced-filters");
      const icon = this.querySelector(".bi");
      
      if (advancedFilters.style.display === "block") {
        advancedFilters.style.display = "none";
        icon.classList.replace("bi-chevron-up", "bi-chevron-down");
      } else {
        advancedFilters.style.display = "block";
        icon.classList.replace("bi-chevron-down", "bi-chevron-up");
      }
    });

    // تحديث قيمة شريط السعر
    document.getElementById("priceRange").addEventListener("input", function() {
      const value = parseInt(this.value).toLocaleString();
      document.getElementById("priceRangeValue").textContent = `0 - ${value}`;
    });

    // إعادة تعيين الفلتر
    document.getElementById("resetFilters").addEventListener("click", function() {
      document.getElementById("filterDistrict").value = "";
      document.getElementById("filterCategory").value = "";
      document.getElementById("filterPurpose").value = "";
      document.getElementById("priceRange").value = 10000000;
      document.getElementById("priceRangeValue").textContent = "0 - 10,000,000";
      document.getElementById("filterFeatured").checked = false;
      document.getElementById("filterExclusive").checked = false;
      document.getElementById("filterNew").checked = false;
      document.getElementById("filterRooms").value = "";
      document.getElementById("filterBathrooms").value = "";
      document.getElementById("filterArea").value = "";
      document.getElementById("sortProperties").value = "newest";
      
      // إعادة عرض جميع العقارات
      filteredList = [...properties];
      generatePropertyCards(filteredList);
    });

    // تطبيق الفلتر
    document.getElementById("applyFilters").addEventListener("click", function() {
      const district = document.getElementById("filterDistrict").value;
      const category = document.getElementById("filterCategory").value;
      const purpose = document.getElementById("filterPurpose").value;
      const maxPrice = parseInt(document.getElementById("priceRange").value);
      const isFeatured = document.getElementById("filterFeatured").checked;
      const isExclusive = document.getElementById("filterExclusive").checked;
      const isNew = document.getElementById("filterNew").checked;
      const rooms = document.getElementById("filterRooms").value;
      const bathrooms = document.getElementById("filterBathrooms").value;
      const area = document.getElementById("filterArea").value;
      const sortBy = document.getElementById("sortProperties").value;
      
      // تطبيق الفلتر على العقارات
      filteredList = properties.filter(prop => {
        // تصفية حسب الحي
        if (district && prop.district !== district) return false;
        
        // تصفية حسب التصنيف
        if (category && prop.category !== category) return false;
        
        // تصفية حسب الغرض
        if (purpose && prop.purpose !== purpose) return false;
        
        // تصفية حسب السعر
        if (prop.price > maxPrice) return false;
        
        // تصفية حسب الميزات
        if (isFeatured && !prop.isFeatured) return false;
        if (isExclusive && !prop.isExclusive) return false;
        if (isNew && !prop.isNew) return false;
        
        // تصفية حسب عدد الغرف
        if (rooms) {
          if (rooms === "5+" && (!prop.rooms || prop.rooms < 5)) return false;
          if (rooms !== "5+" && prop.rooms != rooms) return false;
        }
        
        // تصفية حسب عدد الحمامات
        if (bathrooms) {
          if (bathrooms === "4+" && (!prop.bathrooms || prop.bathrooms < 4)) return false;
          if (bathrooms !== "4+" && prop.bathrooms != bathrooms) return false;
        }
        
        // تصفية حسب المساحة
        if (area) {
          if (!prop.area) return false;
          
          if (area === "0-100" && prop.area > 100) return false;
          if (area === "100-200" && (prop.area < 100 || prop.area > 200)) return false;
          if (area === "200-500" && (prop.area < 200 || prop.area > 500)) return false;
          if (area === "500+" && prop.area < 500) return false;
        }
        
        return true;
      });
      
      // ترتيب العقارات
      if (sortBy === "priceAsc") {
        filteredList.sort((a, b) => a.price - b.price);
      } else if (sortBy === "priceDesc") {
        filteredList.sort((a, b) => b.price - a.price);
      } else if (sortBy === "viewsDesc") {
        filteredList.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
      } else {
        // الترتيب حسب الأحدث (افتراضي)
        filteredList.sort((a, b) => b.updatedAt - a.updatedAt);
      }
      
      generatePropertyCards(filteredList);
      showToast("تم تطبيق الفلتر بنجاح");
    });

    let properties = [];
    let filteredList = [];
    let projects = [];
    let customerAds = [];
    
    function loadProperties() {
      document.getElementById("loadingProperties").style.display = "block";
      
      // استخدام once لجلب كل العقارات دون تحديد حد
      propertiesRef.once("value")
        .then(snapshot => {
          const data = snapshot.val();
          // استخدام بيانات Firebase إذا وجدت، وإلا استخدام البيانات المحلية
          if (data) {
            properties = Object.values(data);
          } else {
            console.log("لم يتم العثور على بيانات في Firebase، استخدام البيانات المحلية");
            properties = [...localProperties];
          }
          
          // تحديث الواجهة
          filteredList = [...properties];
          updateAdminTable();
          generatePropertyCards(filteredList);
          document.getElementById("loadingProperties").style.display = "none";
        })
        .catch(err => {
          console.error("Error loading properties:", err);
          // استخدام البيانات المحلية في حالة حدوث خطأ
          properties = [...localProperties];
          filteredList = [...properties];
          updateAdminTable();
          generatePropertyCards(filteredList);
          document.getElementById("loadingProperties").style.display = "none";
        });
    }
    
    function loadProjects() {
      projectsRef.once("value")
        .then(snapshot => {
          const data = snapshot.val();
          projects = data ? Object.values(data) : [];
          updateProjectsTable();
          generateProjectCards();
        })
        .catch(err => {
          console.error("Error loading projects:", err);
          // بيانات مشاريع محلية احتياطية
          projects = [
            {
              id: "project1",
              title: "مشروع الواحة السكني",
              location: "شمال الطائف",
              description: "مشروع سكني متكامل يضم فلل وشقق فاخرة مع مساحات خضراء وخدمات متكاملة.",
              image: "https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&auto=format",
              completionDate: new Date().toISOString()
            }
          ];
          updateProjectsTable();
          generateProjectCards();
        });
    }
    
    function loadCustomerAds() {
      customerAdsRef.once("value")
        .then(snapshot => {
          const data = snapshot.val();
          customerAds = data ? Object.values(data) : [];
          updateCustomerAdsContainer();
        })
        .catch(err => {
          console.error("Error loading customer ads:", err);
          // بيانات إعلانات محلية احتياطية
          customerAds = [
            {
              id: "ad1",
              customerName: "أحمد محمد",
              customerPhone: "0512345678",
              title: "فيلا للبيع في حي الشهداء",
              district: "الشهداء",
              price: 1800000,
              category: "فلل",
              purpose: "للبيع",
              status: "pending",
              createdAt: Date.now()
            }
          ];
          updateCustomerAdsContainer();
        });
    }

    async function getNextId() {
      const result = await nextIdRef.transaction(currentValue => (currentValue || 0) + 1);
      if(result.committed) {
        return result.snapshot.val();
      } else {
        throw new Error("Transaction not committed");
      }
    }

    function numberToArabicWords(num) {
      if (num === 0) return "صفر";
      const ones = ["", "واحد", "اثنان", "ثلاثة", "أربعة", "خمسة", "ستة", "سبعة", "ثمانية", "تسعة"];
      const tens = ["", "عشرة", "عشرون", "ثلاثون", "أربعون", "خمسون", "ستون", "سبعون", "ثمانون", "تسعون"];
      const teens = ["عشرة", "أحد عشر", "اثنا عشر", "ثلاثة عشر", "أربعة عشر", "خمسة عشر", "ستة عشر", "سبعة عشر", "ثمانية عشر", "تسعة عشر"];
      const hundreds = ["", "مائة", "مئتان", "ثلاثمائة", "أربعمائة", "خمسمائة", "ستمائة", "سبعمائة", "ثمانمائة", "تسعمائة"];
      let result = "";
      if (num >= 1000000) {
        let millions = Math.floor(num / 1000000);
        result += numberToArabicWords(millions) + " مليون";
        num %= 1000000;
        if (num > 0) result += " و ";
      }
      if (num >= 1000) {
        let thousands = Math.floor(num / 1000);
        if (thousands === 1) result += "ألف";
        else if (thousands === 2) result += "ألفان";
        else if (thousands < 11) result += numberToArabicWords(thousands) + " آلاف";
        else result += numberToArabicWords(thousands) + " ألف";
        num %= 1000;
        if (num > 0) result += " و ";
      }
      if (num >= 100) {
        let h = Math.floor(num / 100);
        result += hundreds[h];
        num %= 100;
        if (num > 0) result += " و ";
      }
      if (num >= 20) {
        let t = Math.floor(num / 10);
        result += tens[t];
        num %= 10;
        if (num > 0) result += " و " + ones[num];
      } else if (num >= 10) {
        result += teens[num - 10];
      } else if (num > 0) {
        result += ones[num];
      }
      return result;
    }

    function debounce(func, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function lazyLoadImages() {
      const images = document.querySelectorAll('img[loading="lazy"][data-src]');
      const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if(entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            observer.unobserve(img);
          }
        });
      });
      images.forEach(img => observer.observe(img));
    }

    function generatePropertyCards(list = filteredList) {
      const container = document.getElementById("propertiesContainer");
      container.innerHTML = "";
      if(list.length === 0) {
        container.innerHTML = '<p class="text-center py-3">لا توجد عقارات متاحة</p>';
        return;
      }
      list.forEach(prop => {
        const numericPrice = parseInt(prop.price);
        const priceDisplay = numericPrice.toLocaleString() + " ريال";
        const mainSrc = prop.mainImage ? prop.mainImage : "https://via.placeholder.com/500x280?text=No+Image";
        const col = document.createElement("div");
        col.className = "col-md-4 mb-4";
        
        let cardClasses = "property-card";
        let tags = "";
        
        if (prop.isFeatured) {
          cardClasses += " featured-property";
          tags += '<div class="featured-tag">عقار مميز</div>';
        }
        
        if (prop.isExclusive) {
          cardClasses += " exclusive-property";
          tags += '<div class="exclusive-tag">عرض حصري</div>';
        }
        
        if (prop.isNew) {
          tags += '<div class="new-tag">جديد</div>';
        }
        
        const purposeBadgeClass = prop.purpose === 'للبيع' ? 'bg-info' : 'bg-purple';
        const purposeBadge = prop.purpose ? `<span class="badge ${purposeBadgeClass} position-absolute" style="top: 10px; right: ${prop.isFeatured || prop.isExclusive || prop.isNew ? '100px' : '10px'};">${prop.purpose}</span>` : '';
        
        col.innerHTML = `
          <div class="${cardClasses}">
            <span class="badge-category">${prop.category}</span>
            ${tags}
            ${purposeBadge}
            <img data-src="${mainSrc}" loading="lazy" alt="العقار ${prop.id}" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x280?text=No+Image';">
            <div class="card-body">
              <h5 style="color: var(--accent-color);">${prop.title}</h5>
              <p class="mb-1"><i class="bi bi-geo-alt-fill text-danger"></i> ${prop.location}</p>
              <p style="font-size:1.1rem; font-weight:700; color: var(--primary-color);">السعر: ${priceDisplay}</p>
              <p class="mb-1"><i class="bi bi-telephone-fill text-success"></i> ${PHONE_NUMBER}</p>
              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-outline-danger" onclick="showPropertyDetail('${prop.id}')">تفاصيل العقار</button>
                <span class="badge bg-secondary">${prop.viewCount || 0} مشاهدة</span>
              </div>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
      lazyLoadImages();
    }
    
    function generateProjectCards() {
      const container = document.getElementById("projectsContainer");
      container.innerHTML = "";
      
      if (projects.length === 0) {
        container.innerHTML = '<p class="text-center py-3">لا توجد مشاريع متاحة حالياً</p>';
        return;
      }
      
      projects.forEach(project => {
        const col = document.createElement("div");
        col.className = "col-md-4 mb-4";
        
        const completionDate = project.completionDate ? new Date(project.completionDate).toLocaleDateString('ar-SA') : 'غير محدد';
        
        col.innerHTML = `
          <div class="project-card">
            <img src="${project.image}" alt="${project.title}" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x280?text=No+Image';">
            <div class="project-details">
              <h3 class="project-title">${project.title}</h3>
              <p class="project-description">${project.description}</p>
              <div class="project-meta">
                <span><i class="bi bi-geo-alt-fill text-danger"></i> ${project.location}</span>
                <span><i class="bi bi-calendar-check text-primary"></i> ${completionDate}</span>
              </div>
              <button class="btn btn-outline-primary w-100 mt-3" onclick="showProjectDetail('${project.id}')">
                تفاصيل المشروع
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(col);
      });
    }
    
    function updateCustomerAdsContainer(status = 'all') {
      const container = document.getElementById("customerAdsContainer");
      container.innerHTML = "";
      
      const filteredAds = status === 'all' ? customerAds : customerAds.filter(ad => ad.status === status);
      
      if (filteredAds.length === 0) {
        container.innerHTML = '<div class="alert alert-info">لا توجد إعلانات في هذه الفئة</div>';
        return;
      }
      
      filteredAds.forEach(ad => {
        const card = document.createElement("div");
        card.className = "customer-ad-card";
        
        const statusClass = ad.status === 'pending' ? 'pending' : (ad.status === 'approved' ? 'approved' : 'rejected');
        const statusText = ad.status === 'pending' ? 'بانتظار الموافقة' : (ad.status === 'approved' ? 'تمت الموافقة' : 'مرفوض');
        
        card.innerHTML = `
          <div class="customer-header">
            <div class="customer-name">${ad.customerName}</div>
            <div class="ad-status ${statusClass}">${statusText}</div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>عنوان العرض:</strong> ${ad.title}</p>
              <p><strong>الموقع:</strong> ${ad.district}</p>
              <p><strong>السعر:</strong> ${parseInt(ad.price).toLocaleString()} ريال</p>
            </div>
            <div class="col-md-6">
              <p><strong>رقم الواتساب:</strong> ${ad.customerPhone}</p>
              <p><strong>التصنيف:</strong> ${ad.category}</p>
              <p><strong>تاريخ الطلب:</strong> ${new Date(ad.createdAt).toLocaleDateString('ar-SA')}</p>
            </div>
          </div>
          ${ad.status === 'pending' ? `
          <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="approveCustomerAd('${ad.id}')">موافقة</button>
            <button class="btn btn-danger" onclick="rejectCustomerAd('${ad.id}')">رفض</button>
            <a href="https://wa.me/${ad.customerPhone}" target="_blank" class="btn btn-outline-success">
              <i class="bi bi-whatsapp"></i> تواصل مع العميل
            </a>
          </div>
          ` : ''}
        `;
        
        container.appendChild(card);
      });
    }

    function incrementViewCount(propertyId) {
      const viewCountRef = firebase.database().ref(`properties/${propertyId}/viewCount`);
      viewCountRef.transaction(current => (current || 0) + 1)
        .catch(err => console.error("Error updating view count:", err));
    }

    function showPropertyDetail(id) {
      const prop = properties.find(p => p.id == id);
      if(!prop) return;
      incrementViewCount(id);
      document.getElementById("publicContent").style.display = "none";
      document.getElementById("projectsSection").style.display = "none";
      document.getElementById("propertyDetailPage").style.display = "block";
      const detail = document.getElementById("detailContent");
      
      let allImages = [];
      if(prop.mainImage) allImages.push(prop.mainImage);
      if(prop.images && prop.images.length) allImages.push(...prop.images);
      
      let indicators = "";
      let items = "";
      allImages.forEach((img, index) => {
        indicators += `<button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="${index}" ${index===0?'class="active" aria-current="true"':''} aria-label="Slide ${index+1}"></button>`;
        items += `<div class="carousel-item ${index===0?'active':''}">
                    <img src="${img}" alt="Slide ${index+1}" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x280?text=No+Image';">
                  </div>`;
      });
      if(allImages.length === 0) {
        indicators = "";
        items = `<div class="carousel-item active">
                   <img src="https://via.placeholder.com/500x280?text=No+Image" alt="No Image">
                 </div>`;
      }
      const numericPrice = parseInt(prop.price);
      const numericPriceDisplay = numericPrice.toLocaleString() + " ريال";
      
      // إضافة سعر العقار بالحروف العربية
      const priceInWords = numberToArabicWords(numericPrice);
      
      let featureTags = '';
      if (prop.isFeatured) featureTags += '<span class="badge bg-warning text-dark mx-1">عقار مميز</span>';
      if (prop.isExclusive) featureTags += '<span class="badge" style="background-color: var(--exclusive-color);">عرض حصري</span>';
      if (prop.isNew) featureTags += '<span class="badge bg-success mx-1">جديد</span>';
      
      const purposeBadge = prop.purpose ? `<span class="badge ${prop.purpose === 'للبيع' ? 'bg-info' : 'bg-purple'} mx-1">${prop.purpose}</span>` : '';
      
      // بناء نص رسالة الواتساب
      const whatsappText = `مرحبًا، أود الاستفسار عن هذا العقار:
رقم الإعلان: ${prop.id}
العنوان: ${prop.title}
الموقع: ${prop.location}
التصنيف: ${prop.category}
الغرض: ${prop.purpose || ''}
السعر: ${numericPriceDisplay}`;
      
      detail.innerHTML = `
        <div class="row">
          <div class="col-md-8">
            <div id="propertyCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
              <div class="carousel-indicators">${indicators}</div>
              <div class="carousel-inner">${items}</div>
              <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">السابق</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">التالي</span>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card mb-3">
              <div class="card-body">
                <h3 class="mb-2 text-primary fw-bold">${prop.title}</h3>
                <div class="mb-2">
                  ${featureTags}
                  ${purposeBadge}
                </div>
                <p class="mb-2"><strong>رقم الإعلان:</strong> ${prop.id}</p>
                <p class="mb-2"><i class="bi bi-geo-alt-fill text-danger"></i> ${prop.location}</p>
                <p class="mb-2"><strong>السعر:</strong> <span class="fw-bold text-danger fs-5">${numericPriceDisplay}</span></p>
                <p class="mb-2"><small>(${priceInWords} ريال)</small></p>
                <p class="mb-2"><i class="bi bi-telephone-fill text-success"></i> ${PHONE_NUMBER}</p>
                <a href="https://wa.me/966${PHONE_NUMBER.substring(1)}?text=${encodeURIComponent(whatsappText)}" target="_blank" class="btn btn-success w-100 fw-bold btn-whatsapp">
                  <i class="bi bi-whatsapp"></i> تواصل عبر واتساب
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <h4 class="mb-3">وصف العقار</h4>
            <p class="description-text">${prop.description || 'لا يوجد وصف متاح'}</p>
          </div>
        </div>
      `;
    }
    
    function showProjectDetail(id) {
      const project = projects.find(p => p.id == id);
      if (!project) return;
      
      // يمكن إضافة منطق عرض تفاصيل المشروع هنا لاحقاً
      alert("سيتم إضافة صفحة تفاصيل المشروع قريباً");
    }
    
    function backToListing() {
      document.getElementById("propertyDetailPage").style.display = "none";
      document.getElementById("publicContent").style.display = "block";
      document.getElementById("projectsSection").style.display = "block";
    }

    function filterProperties(category) {
      if(category === 'all') {
        filteredList = [...properties];
      } else {
        filteredList = properties.filter(p => p.category === category);
      }
      generatePropertyCards(filteredList);
    }

    var searchInput = document.getElementById("searchInput");
    if (searchInput) {
      searchInput.addEventListener("input", debounce(function() {
        const query = this.value.trim().toLowerCase();
        if(query === "") {
          filteredList = [...properties];
        } else {
          filteredList = properties.filter(p => {
            const searchable = `${p.title || ""} ${p.location || ""} ${p.price || ""} ${p.description || ""} ${p.category || ""}`.toLowerCase();
            return searchable.includes(query);
          });
        }
        generatePropertyCards(filteredList);
      }, 300));
    }
    
    document.getElementById("adStatusFilter").addEventListener("change", function() {
      updateCustomerAdsContainer(this.value);
    });

    function scrollToProperties() {
      document.getElementById("publicContent").scrollIntoView({ behavior: "smooth" });
    }

    function updateAdminTable() {
      const tbody = document.getElementById("adminTableBody");
      tbody.innerHTML = "";
      const sortedProps = [...properties].sort((a, b) => a.id - b.id);
      sortedProps.forEach((prop, index) => {
        const numericPrice = parseInt(prop.price);
        const priceDisplay = numericPrice.toLocaleString() + " ريال";
        
        let featureBadges = '';
        if (prop.isFeatured) featureBadges += '<span class="badge bg-warning text-dark">مميز</span> ';
        if (prop.isExclusive) featureBadges += '<span class="badge" style="background-color: var(--exclusive-color);">حصري</span> ';
        if (prop.isNew) featureBadges += '<span class="badge bg-success">جديد</span> ';
        if (!prop.isFeatured && !prop.isExclusive && !prop.isNew) featureBadges = '-';
        
        const purposeDisplay = prop.purpose || '-';
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${prop.title}</td>
          <td>${prop.location}</td>
          <td>${priceDisplay}</td>
          <td>${prop.category}</td>
          <td>${purposeDisplay}</td>
          <td>${featureBadges}</td>
          <td>
            <span class="action-badge edit" onclick="editProperty('${prop.id}')">تعديل</span>
            <span class="action-badge delete" onclick="deleteProperty('${prop.id}')">حذف</span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    function updateProjectsTable() {
      const tbody = document.getElementById("projectsTableBody");
      tbody.innerHTML = "";
      
      if (projects.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center">لا توجد مشاريع مضافة</td></tr>`;
        return;
      }
      
      const sortedProjects = [...projects].sort((a, b) => a.id - b.id);
      sortedProjects.forEach((project, index) => {
        const completionDate = project.completionDate ? new Date(project.completionDate).toLocaleDateString('ar-SA') : 'غير محدد';
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${project.title}</td>
          <td>${project.location}</td>
          <td>${completionDate}</td>
          <td>
            <span class="action-badge edit" onclick="editProject('${project.id}')">تعديل</span>
            <span class="action-badge delete" onclick="deleteProject('${project.id}')">حذف</span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function saveProperty(propertyData) {
      return propertiesRef.child(propertyData.id).set(propertyData)
      .then(() => {
        const index = properties.findIndex(p => p.id == propertyData.id);
        if(index >= 0) {
          properties[index] = propertyData;
        } else {
          properties.push(propertyData);
        }
        filteredList = [...properties];
        updateAdminTable();
        generatePropertyCards(filteredList);
      })
      .catch(err => {
        console.error("Error saving property:", err);
      });
    }
    
    function saveProject(projectData) {
      return projectsRef.child(projectData.id).set(projectData)
      .then(() => {
        const index = projects.findIndex(p => p.id == projectData.id);
        if(index >= 0) {
          projects[index] = projectData;
        } else {
          projects.push(projectData);
        }
        updateProjectsTable();
        generateProjectCards();
      })
      .catch(err => {
        console.error("Error saving project:", err);
      });
    }
    
    function approveCustomerAd(adId) {
      if (!confirm("هل أنت متأكد من الموافقة على هذا الإعلان؟")) return;
      
      const ad = customerAds.find(a => a.id == adId);
      if (!ad) return;
      
      // تحديث حالة الإعلان
      customerAdsRef.child(adId).update({ status: 'approved' })
      .then(async () => {
        // إضافة العقار إلى قائمة العقارات
        const propertyId = await getNextId();
        
        const propertyData = {
          id: propertyId,
          title: ad.title,
          location: ad.district,
          district: ad.district,
          price: parseInt(ad.price),
          category: ad.category,
          purpose: ad.purpose,
          mainImage: ad.mainImage,
          images: ad.additionalImages || [],
          description: ad.description,
          isFeatured: false,
          isExclusive: false,
          isNew: true,
          updatedAt: Date.now(),
          createdAt: Date.now(),
          viewCount: 0,
          sourceAdId: ad.id
        };
        
        await saveProperty(propertyData);
        showToast("تمت الموافقة على الإعلان وإضافته إلى قائمة العقارات");
        
        // تحديث القائمة
        const index = customerAds.findIndex(a => a.id == adId);
        customerAds[index].status = 'approved';
        updateCustomerAdsContainer(document.getElementById("adStatusFilter").value);
      })
      .catch(err => {
        console.error("Error approving ad:", err);
        showToast("حدث خطأ أثناء الموافقة على الإعلان", "danger");
      });
    }
    
    function rejectCustomerAd(adId) {
      if (!confirm("هل أنت متأكد من رفض هذا الإعلان؟")) return;
      
      const reason = prompt("يرجى إدخال سبب الرفض:");
      if (reason === null) return;
      
      customerAdsRef.child(adId).update({ 
        status: 'rejected',
        rejectionReason: reason,
        rejectedAt: Date.now()
      })
      .then(() => {
        showToast("تم رفض الإعلان بنجاح");
        
        // تحديث القائمة
        const index = customerAds.findIndex(a => a.id == adId);
        customerAds[index].status = 'rejected';
        customerAds[index].rejectionReason = reason;
        customerAds[index].rejectedAt = Date.now();
        updateCustomerAdsContainer(document.getElementById("adStatusFilter").value);
      })
      .catch(err => {
        console.error("Error rejecting ad:", err);
        showToast("حدث خطأ أثناء رفض الإعلان", "danger");
      });
    }

    document.getElementById("propertyForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const saveBtn = document.getElementById("saveBtn");
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'جارٍ الحفظ... <i class="bi bi-arrow-repeat spin"></i>';
      try {
        const idField = document.getElementById("propertyId").value;
        let propertyId;
        if(!idField) {
          propertyId = await getNextId();
        } else {
          propertyId = parseInt(idField, 10);
        }
        const title = document.getElementById("title").value;
        const location = document.getElementById("location").value;
        const districtSelect = document.getElementById("district");
        let district = districtSelect.value;
        
        // التعامل مع خيار "أخرى" للأحياء
        if (district === "أخرى") {
          district = document.getElementById("otherDistrict").value || "أخرى";
        }
        
        const price = document.getElementById("price").value;
        const category = document.getElementById("category").value;
        const purpose = document.getElementById("purpose").value;
        const description = document.getElementById("description").value;
        
        // القيم الجديدة التي أضفناها
        const isFeatured = document.getElementById("isFeatured").checked;
        const isExclusive = document.getElementById("isExclusive").checked;
        const isNew = document.getElementById("isNew").checked;
        
        let mainImageURL = "";
        const mainFile = document.getElementById("mainImageFile").files[0];
        if(mainFile) {
          mainImageURL = await getFileDataURL(mainFile);
        } else if(idField) {
          const existing = properties.find(p => p.id == idField);
          if(existing) mainImageURL = existing.mainImage;
        }
        let additionalImagesURL = [];
        const additionalFiles = document.getElementById("additionalImages").files;
        if(additionalFiles.length) {
          additionalImagesURL = await Promise.all([...additionalFiles].map(file => getFileDataURL(file)));
        } else if(idField) {
          const existing = properties.find(p => p.id == idField);
          if(existing) additionalImagesURL = existing.images || [];
        }
        const numericPrice = parseInt(price.toString().replace(/,/g, ''));
        const propertyData = {
          id: propertyId,
          title,
          location,
          district,
          price: numericPrice,
          priceText: "",
          category,
          purpose,
          mainImage: mainImageURL,
          images: additionalImagesURL,
          description,
          isFeatured,
          isExclusive,
          isNew,
          updatedAt: Date.now(),
          createdAt: idField ? (properties.find(p => p.id == idField)?.createdAt || Date.now()) : Date.now(),
          viewCount: idField ? (properties.find(p => p.id == idField)?.viewCount || 0) : 0
        };
        await saveProperty(propertyData);
        showToast("تم حفظ التعديلات بنجاح");
        document.getElementById("propertyForm").reset();
        document.getElementById("propertyId").value = "";
        document.getElementById("additionalImagesPreview").innerHTML = "";
        document.getElementById("otherDistrictContainer").style.display = "none";
        localStorage.removeItem("propertyDraft");
      } catch (error) {
        console.error("خطأ في الحفظ:", error);
        alert("حدث خطأ أثناء حفظ البيانات، حاول مرة أخرى.");
      }
      saveBtn.disabled = false;
      saveBtn.innerHTML = 'حفظ التعديلات';
    });
    
    document.getElementById("projectForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const saveBtn = document.getElementById("saveProjectBtn");
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'جارٍ الحفظ... <i class="bi bi-arrow-repeat spin"></i>';
      
      try {
        const idField = document.getElementById("projectId").value;
        let projectId;
        if (!idField) {
          projectId = Date.now().toString();
        } else {
          projectId = idField;
        }
        
        const title = document.getElementById("projectTitle").value;
        const location = document.getElementById("projectLocation").value;
        const description = document.getElementById("projectDescription").value;
        const completionDate = document.getElementById("projectCompletionDate").value;
        
        let imageURL = "";
        const imageFile = document.getElementById("projectImageFile").files[0];
        if (imageFile) {
          imageURL = await getFileDataURL(imageFile);
        } else if (idField) {
          const existing = projects.find(p => p.id == idField);
          if (existing) imageURL = existing.image;
        }
        
        if (!imageURL && !idField) {
          throw new Error("يجب اختيار صورة للمشروع");
        }
        
        const projectData = {
          id: projectId,
          title,
          location,
          description,
          completionDate,
          image: imageURL,
          updatedAt: Date.now(),
          createdAt: idField ? (projects.find(p => p.id == idField)?.createdAt || Date.now()) : Date.now()
        };
        
        await saveProject(projectData);
        showToast("تم حفظ المشروع بنجاح");
        document.getElementById("projectForm").reset();
        document.getElementById("projectId").value = "";
        document.getElementById("projectImagePreview").innerHTML = "";
      } catch (error) {
        console.error("خطأ في حفظ المشروع:", error);
        alert("حدث خطأ أثناء حفظ المشروع، حاول مرة أخرى: " + error.message);
      }
      
      saveBtn.disabled = false;
      saveBtn.innerHTML = 'حفظ المشروع';
    });
    
    document.getElementById("newCustomerPropertyForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById("submitCustomerProperty");
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'جارٍ الإرسال... <i class="bi bi-arrow-repeat spin"></i>';
      
      try {
        // جمع البيانات
        const customerName = document.getElementById("customerName").value;
        const customerPhone = document.getElementById("customerPhone").value;
        const title = document.getElementById("customerPropertyTitle").value;
        
        const districtSelect = document.getElementById("customerPropertyDistrict");
        let district = districtSelect.value;
        if (district === "أخرى") {
          district = document.getElementById("customerOtherDistrict").value || "أخرى";
        }
        
        const price = document.getElementById("customerPropertyPrice").value;
        const category = document.getElementById("customerPropertyCategory").value;
        const purpose = document.getElementById("customerPropertyPurpose").value;
        const description = document.getElementById("customerPropertyDescription").value;
        
        // التعامل مع المتعثرات
        let propertyIssues = document.querySelector('input[name="hasIssues"]:checked').value;
        if (propertyIssues === "أخرى") {
          propertyIssues = document.getElementById("otherIssues").value;
        }
        
        // معالجة الصور
        const mainImageFile = document.getElementById("customerPropertyMainImage").files[0];
        const additionalImagesFiles = document.getElementById("customerPropertyAdditionalImages").files;
        
        if (!mainImageFile) {
          throw new Error("يجب اختيار صورة رئيسية للعقار");
        }
        
        const mainImageURL = await getFileDataURL(mainImageFile);
        let additionalImagesURL = [];
        
        if (additionalImagesFiles.length) {
          additionalImagesURL = await Promise.all([...additionalImagesFiles].map(file => getFileDataURL(file)));
        }
        
        // إنشاء معرف فريد للإعلان
        const adId = "ad_" + Date.now();
        
        // بناء كائن الإعلان
        const adData = {
          id: adId,
          customerName,
          customerPhone,
          title,
          district,
          price: parseInt(price.toString().replace(/,/g, '')),
          category,
          purpose,
          description,
          propertyIssues,
          mainImage: mainImageURL,
          additionalImages: additionalImagesURL,
          status: 'pending',
          createdAt: Date.now()
        };
        
        // حفظ الإعلان في قاعدة البيانات
        await customerAdsRef.child(adId).set(adData);
        
        // إغلاق النموذج وإظهار رسالة نجاح
        document.getElementById("customerPropertyForm").style.display = "none";
        document.body.style.overflow = "auto";
        showToast("تم إرسال طلبك بنجاح، سيتم مراجعته من قبل الإدارة قريباً");
        
        // إعادة تعيين النموذج
        document.getElementById("newCustomerPropertyForm").reset();
        
        // تحديث قائمة الإعلانات في لوحة الإدارة
        customerAds.push(adData);
        if (document.getElementById("adminPanel").style.display === "block") {
          updateCustomerAdsContainer(document.getElementById("adStatusFilter").value);
        }
      } catch (error) {
        console.error("خطأ في إرسال الطلب:", error);
        alert("حدث خطأ أثناء إرسال الطلب، حاول مرة أخرى: " + error.message);
      }
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'إرسال الطلب';
    });

    function getFileDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) { resolve(e.target.result); };
        reader.onerror = function(e) { reject(e); };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById("propertyForm").addEventListener("input", function() {
      const draft = {
        propertyId: document.getElementById("propertyId").value,
        title: document.getElementById("title").value,
        location: document.getElementById("location").value,
        district: document.getElementById("district").value,
        price: document.getElementById("price").value,
        category: document.getElementById("category").value,
        purpose: document.getElementById("purpose").value,
        description: document.getElementById("description").value,
        isFeatured: document.getElementById("isFeatured").checked,
        isExclusive: document.getElementById("isExclusive").checked,
        isNew: document.getElementById("isNew").checked
      };
      localStorage.setItem("propertyDraft", JSON.stringify(draft));
    });

    document.getElementById("newPropertyBtn").addEventListener("click", function() {
      document.getElementById("propertyForm").reset();
      document.getElementById("propertyId").value = "";
      document.getElementById("additionalImagesPreview").innerHTML = "";
      document.getElementById("otherDistrictContainer").style.display = "none";
      window.scrollTo(0, document.getElementById("adminPanel").offsetTop);
    });

    document.getElementById("newProjectBtn").addEventListener("click", function() {
      document.getElementById("projectForm").reset();
      document.getElementById("projectId").value = "";
      document.getElementById("projectImagePreview").innerHTML = "";
    });

    function editProperty(id) {
      const prop = properties.find(p => p.id == id);
      if(!prop) return;
      document.getElementById("propertyId").value = prop.id;
      document.getElementById("title").value = prop.title;
      document.getElementById("location").value = prop.location;
      
      // إعداد الحي
      const districtSelect = document.getElementById("district");
      const districtOptions = Array.from(districtSelect.options).map(opt => opt.value);
      
      if (prop.district && districtOptions.includes(prop.district)) {
        districtSelect.value = prop.district;
        document.getElementById("otherDistrictContainer").style.display = "none";
      } else if (prop.district) {
        districtSelect.value = "أخرى";
        document.getElementById("otherDistrictContainer").style.display = "block";
        document.getElementById("otherDistrict").value = prop.district;
      } else {
        districtSelect.value = "";
        document.getElementById("otherDistrictContainer").style.display = "none";
      }
      
      document.getElementById("price").value = prop.price;
      document.getElementById("category").value = prop.category || "";
      document.getElementById("purpose").value = prop.purpose || "";
      document.getElementById("description").value = prop.description;
      
      // تعبئة الميزات
      document.getElementById("isFeatured").checked = prop.isFeatured || false;
      document.getElementById("isExclusive").checked = prop.isExclusive || false;
      document.getElementById("isNew").checked = prop.isNew || false;
      
      const previewContainer = document.getElementById("additionalImagesPreview");
      previewContainer.innerHTML = "";
      if(prop.images && prop.images.length) {
        prop.images.forEach(img => {
          const imageElem = document.createElement("img");
          imageElem.src = img;
          imageElem.alt = "صورة العقار";
          previewContainer.appendChild(imageElem);
        });
      }
      
      // التبديل إلى تبويب العقارات
      document.getElementById("properties-tab").click();
      
      window.scrollTo(0, document.getElementById("adminPanel").offsetTop);
    }
    
    function editProject(id) {
      const project = projects.find(p => p.id == id);
      if (!project) return;
      
      document.getElementById("projectId").value = project.id;
      document.getElementById("projectTitle").value = project.title;
      document.getElementById("projectLocation").value = project.location;
      document.getElementById("projectDescription").value = project.description;
      
      if (project.completionDate) {
        document.getElementById("projectCompletionDate").value = project.completionDate;
      }
      
      const previewContainer = document.getElementById("projectImagePreview");
      previewContainer.innerHTML = "";
      if (project.image) {
        const imageElem = document.createElement("img");
        imageElem.src = project.image;
        imageElem.alt = "صورة المشروع";
        imageElem.style.width = "100%";
        imageElem.style.maxHeight = "200px";
        imageElem.style.objectFit = "cover";
        imageElem.style.borderRadius = "5px";
        previewContainer.appendChild(imageElem);
      }
      
      // التبديل إلى تبويب المشاريع
      document.getElementById("projects-tab").click();
      
      window.scrollTo(0, document.getElementById("adminPanel").offsetTop);
    }

    function deleteProperty(id) {
      if(confirm("هل أنت متأكد من حذف هذا العقار؟")) {
        propertiesRef.child(id).remove()
        .then(() => {
          showToast("تم حذف العقار بنجاح");
          properties = properties.filter(p => p.id != id);
          filteredList = [...properties];
          updateAdminTable();
          generatePropertyCards(filteredList);
        })
        .catch(err => { console.error("Error deleting property:", err); });
      }
    }
    
    function deleteProject(id) {
      if (confirm("هل أنت متأكد من حذف هذا المشروع؟")) {
        projectsRef.child(id).remove()
        .then(() => {
          showToast("تم حذف المشروع بنجاح");
          projects = projects.filter(p => p.id != id);
          updateProjectsTable();
          generateProjectCards();
        })
        .catch(err => { console.error("Error deleting project:", err); });
      }
    }

    function updateVisitorCount() {
      const visitorCountRef = firebase.database().ref("visitorCount");
      visitorCountRef.transaction(current => (current || 0) + 1)
        .then(result => {
          const count = result.snapshot.val();
          document.getElementById("visitorCount").textContent = `عدد الزائرين: ${count}`;
        })
        .catch(err => console.error("Error updating visitor count:", err));
    }

    document.addEventListener("DOMContentLoaded", function(){
      if(localStorage.getItem("adminLoggedIn") === "true"){
        document.getElementById("loginPanel").style.display = "none";
        showAdminPanel();
      }
      updateVisitorCount();
      loadProperties();
      loadProjects();
      loadCustomerAds();
      
      const savedDraft = localStorage.getItem("propertyDraft");
      if (savedDraft) {
        try {
          const draft = JSON.parse(savedDraft);
          document.getElementById("propertyId").value = draft.propertyId || "";
          document.getElementById("title").value = draft.title || "";
          document.getElementById("location").value = draft.location || "";
          
          if (draft.district) {
            const districtSelect = document.getElementById("district");
            const districtOptions = Array.from(districtSelect.options).map(opt => opt.value);
            
            if (districtOptions.includes(draft.district)) {
              districtSelect.value = draft.district;
              document.getElementById("otherDistrictContainer").style.display = "none";
            } else {
              districtSelect.value = "أخرى";
              document.getElementById("otherDistrictContainer").style.display = "block";
              document.getElementById("otherDistrict").value = draft.district;
            }
          }
          
          document.getElementById("price").value = draft.price || "";
          document.getElementById("category").value = draft.category || "";
          document.getElementById("purpose").value = draft.purpose || "";
          document.getElementById("description").value = draft.description || "";
          
          document.getElementById("isFeatured").checked = draft.isFeatured || false;
          document.getElementById("isExclusive").checked = draft.isExclusive || false;
          document.getElementById("isNew").checked = draft.isNew || false;
        } catch (e) {
          console.error("Error parsing saved draft:", e);
        }
      }
      
      // تحديث شريط السعر
      document.getElementById("priceRangeValue").textContent = `0 - ${parseInt(document.getElementById("priceRange").value).toLocaleString()}`;
      
      // إضافة معالج الأحداث للملفات
      document.getElementById("projectImageFile").addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const container = document.getElementById("projectImagePreview");
            container.innerHTML = `<img src="${e.target.result}" alt="صورة المشروع" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 5px;">`;
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById("additionalImages").addEventListener("change", function() {
        const files = this.files;
        if (files.length > 0) {
          const container = document.getElementById("additionalImagesPreview");
          container.innerHTML = "";
          Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.createElement("img");
              img.src = e.target.result;
              img.alt = "صورة إضافية";
              container.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        }
      });
    });
  </script>
</body>
</html>